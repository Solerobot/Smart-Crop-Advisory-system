<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agricultural Assistant | Smart Crop Advisory</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      background: linear-gradient(135deg, #f0f9f0 0%, #ffffff 100%);
      overflow: hidden;
    }

    /* Chat Container */
    .chat-container {
      display: flex;
      height: 100vh;
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      z-index: 10;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
    }

    .sidebar-header {
      padding: 24px;
      background: linear-gradient(135deg, #0f5132, #1c7a4d);
      color: white;
    }

    .sidebar-nav {
      padding: 20px;
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      color: #4b5563;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .nav-item:hover {
      background: #f0f9f0;
      color: #0f5132;
      transform: translateX(5px);
    }

    .nav-item i {
      width: 24px;
      margin-right: 12px;
      font-size: 18px;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Welcome Screen */
    .welcome-center {
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 180px);
      padding: 20px;
      background: white;
      padding-bottom: 100px;
    }

    .welcome-center.hidden {
      display: none;
    }

    /* Messages Area */
    .messages-container {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: white;
    }

    .messages-container.hidden {
      display: none;
    }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      padding-bottom: 160px;
    }

    /* Message Bubbles */
    .message-row {
      display: flex;
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-row.assistant {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 75%;
      padding: 16px 20px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .user-message {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border: 2px solid #86efac;
      border-radius: 18px 18px 6px 18px;
      color: #0f5132;
    }

    .bot-message {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border: 2px solid #e5e7eb;
      border-radius: 18px 18px 18px 6px;
      color: #1f2937;
      line-height: 1.7;
    }

    /* Input Section */
    .input-section {
      position: fixed;
      bottom: 0;
      left: 280px;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      padding: 20px;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .input-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      padding: 12px;
    }

    /* Quick Action Buttons */
    .quick-action-btn {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      height: 100px;
    }

    .quick-action-btn:hover {
      border-color: #16a34a;
      background: #f0f9f0;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(22, 163, 74, 0.15);
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #16a34a;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Message Styling */
    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 13px;
    }

    .avatar.user {
      background: #16a34a;
      color: white;
    }

    .avatar.bot {
      background: #4b5563;
      color: white;
    }

    .message-content {
      color: #1f2937;
      font-size: 15px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .timestamp {
      font-size: 12px;
      color: #6b7280;
      text-align: right;
      margin-top: 6px;
    }

    /* Voice Features Styles */
    .voice-btn {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white;
      border: none;
      border-radius: 12px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    }

    .voice-btn:hover:not(.disabled) {
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(22, 163, 74, 0.4);
    }

    .voice-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #9ca3af;
    }

    .voice-btn.listening {
      background: linear-gradient(135deg, #dc2626, #ef4444);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(220, 38, 38, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }

    .tts-btn {
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.2s ease;
      margin-left: 8px;
      margin-top: 4px;
    }

    .tts-btn:hover {
      background: #f0f9f0;
      color: #16a34a;
      border-color: #86efac;
    }

    .tts-btn.speaking {
      background: #dcfce7;
      color: #16a34a;
      border-color: #16a34a;
      animation: subtlePulse 2s infinite;
    }

    @keyframes subtlePulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .listening-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 24px 32px;
      border-radius: 20px;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .listening-indicator.active {
      display: flex;
    }

    .pulse-ring {
      width: 80px;
      height: 80px;
      border: 4px solid #fff;
      border-radius: 50%;
      animation: listeningPulse 1.5s infinite;
    }

    @keyframes listeningPulse {
      0% { transform: scale(0.8); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0.7; }
    }

    .transcript-feedback {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(34, 197, 94, 0.95);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 100;
      animation: slideUp 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
    }

    @keyframes slideUp {
      from { bottom: 80px; opacity: 0; }
      to { bottom: 120px; opacity: 1; }
    }

    .transcript-feedback.fade-out {
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
      transition: all 0.5s ease;
    }

    .voice-settings {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      border: 1px solid #e5e7eb;
    }

    .voice-settings label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      cursor: pointer;
      color: #4b5563;
    }

    .voice-settings input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #16a34a;
    }

    .message-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }

    .privacy-notice {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      font-size: 12px;
      color: #92400e;
    }

    /* Scrollbar */
    .messages-area::-webkit-scrollbar {
      width: 8px;
    }

    .messages-area::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .messages-area::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .messages-area::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 80px;
      }
      
      .sidebar-header h2,
      .nav-item span {
        display: none;
      }
      
      .nav-item {
        justify-content: center;
        padding: 16px;
      }
      
      .nav-item i {
        margin: 0;
        font-size: 20px;
      }
      
      .input-section {
        left: 80px;
      }
      
      .welcome-center {
        height: calc(100vh - 160px);
        padding-bottom: 80px;
      }

      .voice-btn {
        width: 44px;
        height: 44px;
      }

      .input-container .flex {
        gap: 2px;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2 class="text-xl font-bold">üåæ Farm Assistant</h2>
        <p class="text-sm opacity-90 mt-1">Ask anything about farming</p>
      </div>
      
      <div class="sidebar-nav">
        <a href="dashboard.html" class="nav-item">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
        
        <a href="weather.html" class="nav-item">
          <i class="fas fa-cloud-sun"></i>
          <span>Weather</span>
        </a>
        
        <a href="fertilizer.html" class="nav-item">
          <i class="fas fa-seedling"></i>
          <span>Fertilizer</span>
        </a>
        
        <div class="mt-8 pt-6 border-t border-gray-200">
          <div class="text-xs text-gray-500 mb-3 px-4">CHAT ACTIONS</div>
          
          <div onclick="clearChat()" class="nav-item">
            <i class="fas fa-trash-alt"></i>
            <span>Clear Chat</span>
          </div>
          
          <div onclick="exportChat()" class="nav-item">
            <i class="fas fa-download"></i>
            <span>Export Chat</span>
          </div>

          <div onclick="toggleVoiceSettings()" class="nav-item">
            <i class="fas fa-microphone"></i>
            <span>Voice Settings</span>
          </div>
        </div>

        <!-- Voice Settings Panel -->
        <div id="voiceSettingsPanel" class="voice-settings hidden">
          <div class="text-sm font-semibold text-gray-700 mb-3">Voice Settings</div>
          <label>
            <input type="checkbox" id="voiceInputToggle" checked>
            Enable Voice Input
          </label>
          <label>
            <input type="checkbox" id="ttsToggle">
            Enable Text-to-Speech
          </label>
          <label>
            <input type="checkbox" id="autoSendToggle">
            Auto-send short voice queries
          </label>
          <div class="privacy-notice">
            <i class="fas fa-info-circle mr-1"></i>
            Voice input uses Google's speech recognition. Audio is sent to Google for processing.
          </div>
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200">
        <div class="text-center text-sm text-gray-600">
          <p>üí¨ Instant Assistant</p>
          <p class="text-xs mt-1">No login required</p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Welcome Screen -->
      <div id="welcomeCenter" class="welcome-center">
        <div class="text-center max-w-2xl px-4">
          <div class="w-24 h-24 bg-gradient-to-br from-green-100 to-green-200 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
            <span class="text-4xl">ü§ñ</span>
          </div>
          
          <h1 class="text-3xl font-bold text-gray-800 mb-4">Farm AI Assistant</h1>
          <p class="text-lg text-gray-600 mb-8">Ask me anything about crops, weather, pests, or farming techniques</p>
          
          <!-- Quick Action Grid -->
          <div class="grid grid-cols-2 gap-3 max-w-md mx-auto mb-8">
            <button onclick="startQuickChat('What are the best crops to grow in the current season? Tell me about sowing time, duration, and yield expectations.')" class="quick-action-btn">
              <span class="text-xl block mb-2">üåæ</span>
              <div class="text-sm font-medium text-gray-700">Crop Selection</div>
            </button>
            
            <button onclick="startQuickChat('What fertilizer should I use for rice cultivation? Include NPK ratio, quantity per acre, and application schedule.')" class="quick-action-btn">
              <span class="text-xl block mb-2">üå±</span>
              <div class="text-sm font-medium text-gray-700">Fertilizer</div>
            </button>
            
            <button onclick="startQuickChat('How to control pests in tomato crops organically? List preventive measures and treatment methods.')" class="quick-action-btn">
              <span class="text-xl block mb-2">üêõ</span>
              <div class="text-sm font-medium text-gray-700">Pest Control</div>
            </button>
            
            <button onclick="startQuickChat('Best irrigation methods for wheat farming? Include schedule, water requirements, and efficiency tips.')" class="quick-action-btn">
              <span class="text-xl block mb-2">üíß</span>
              <div class="text-sm font-medium text-gray-700">Irrigation</div>
            </button>
          </div>
          
          <p class="text-sm text-gray-500">Type your question below or use the microphone button</p>
        </div>
      </div>

      <!-- Messages Container -->
      <div id="messagesContainer" class="messages-container hidden">
        <div id="messages" class="messages-area">
          <!-- Messages will appear here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Voice Listening Indicator -->
  <div id="listeningIndicator" class="listening-indicator">
    <div class="pulse-ring"></div>
    <div class="text-xl font-semibold">Listening...</div>
    <div class="text-sm opacity-80">Speak now. Click to stop.</div>
  </div>

  <!-- Input Section -->
  <div class="input-section">
    <div class="input-container">
      <div class="flex gap-3 items-end">
        <textarea 
          id="chatInput" 
          placeholder="Type or speak your question about farming..."
          class="flex-1 border-0 focus:ring-0 focus:outline-none resize-none py-3 px-4 text-gray-700 placeholder-gray-500 text-base bg-transparent leading-relaxed"
          rows="1"
          style="min-height: 56px; max-height: 150px;"
        ></textarea>
        
        <!-- Voice Input Button -->
        <button 
          id="voiceBtn" 
          onclick="toggleVoiceInput()" 
          class="voice-btn"
          title="Click to speak"
        >
          <i class="fas fa-microphone"></i>
        </button>
        
        <!-- Send Button -->
        <button 
          id="sendBtn" 
          onclick="sendMessage()" 
          class="bg-green-600 text-white rounded-xl px-5 py-3 font-semibold hover:bg-green-700 transition-colors shadow-md flex items-center gap-2"
        >
          <i class="fas fa-paper-plane"></i>
          <span class="hidden sm:inline">Send</span>
        </button>
      </div>
      
      <div class="mt-3 flex justify-center gap-3">
        <button onclick="suggestPrompt('weather')" class="text-xs text-green-600 hover:text-green-800 px-3 py-1.5 bg-green-50 rounded-full transition-colors border border-green-100">
          <i class="fas fa-cloud-sun mr-1"></i>Weather
        </button>
        <button onclick="suggestPrompt('fertilizer')" class="text-xs text-green-600 hover:text-green-800 px-3 py-1.5 bg-green-50 rounded-full transition-colors border border-green-100">
          <i class="fas fa-seedling mr-1"></i>Fertilizer
        </button>
        <button onclick="suggestPrompt('pest')" class="text-xs text-green-600 hover:text-green-800 px-3 py-1.5 bg-green-50 rounded-full transition-colors border border-green-100">
          <i class="fas fa-bug mr-1"></i>Pest
        </button>
        <button onclick="suggestPrompt('irrigation')" class="text-xs text-green-600 hover:text-green-800 px-3 py-1.5 bg-green-50 rounded-full transition-colors border border-green-100">
          <i class="fas fa-tint mr-1"></i>Water
        </button>
      </div>
    </div>
  </div>

  <script>
    // Voice Assistant Class
    class VoiceAssistant {
      constructor() {
        this.speechSynthesis = window.speechSynthesis;
        this.recognition = null;
        this.isListening = false;
        this.isSpeaking = false;
        this.currentLanguage = 'en-IN';
        this.supportedVoices = [];
        this.voiceEnabled = true;
        this.ttsEnabled = false; // Default OFF - user must enable manually
        this.autoSendEnabled = false;
        this.initSpeechRecognition();
        this.loadVoiceSettings();
        this.loadAvailableVoices();
      }

      initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
          console.warn('Speech recognition not supported in this browser');
          this.showBrowserCompatibilityWarning();
          return;
        }

        this.recognition = new SpeechRecognition();
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.lang = this.currentLanguage;
        
        this.recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          console.log('Voice input:', transcript);
          this.onSpeechResult(transcript);
        };
        
        this.recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          this.isListening = false;
          this.updateListeningUI(false);
          
          if (event.error === 'not-allowed') {
            this.showPermissionError();
          }
        };
        
        this.recognition.onend = () => {
          this.isListening = false;
          this.updateListeningUI(false);
        };
      }

      loadAvailableVoices() {
        const loadVoices = () => {
          this.supportedVoices = this.speechSynthesis.getVoices();
        };
        
        this.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();
      }

      loadVoiceSettings() {
        this.voiceEnabled = localStorage.getItem('voiceEnabled') !== 'false';
        this.ttsEnabled = localStorage.getItem('ttsEnabled') === 'true';
        this.autoSendEnabled = localStorage.getItem('autoSendEnabled') === 'true';
        
        document.getElementById('voiceInputToggle').checked = this.voiceEnabled;
        document.getElementById('ttsToggle').checked = this.ttsEnabled;
        document.getElementById('autoSendToggle').checked = this.autoSendEnabled;
      }

      saveVoiceSettings() {
        localStorage.setItem('voiceEnabled', this.voiceEnabled);
        localStorage.setItem('ttsEnabled', this.ttsEnabled);
        localStorage.setItem('autoSendEnabled', this.autoSendEnabled);
      }

      setLanguage(langCode) {
        const languageMap = {
          'en': 'en-IN',
          'hi': 'hi-IN',
          'te': 'te-IN',
          'ta': 'ta-IN',
          'mr': 'mr-IN',
          'bn': 'bn-IN'
        };
        
        this.currentLanguage = languageMap[langCode] || 'en-IN';
        if (this.recognition) {
          this.recognition.lang = this.currentLanguage;
        }
      }

      startListening() {
        if (!this.recognition || this.isListening || !this.voiceEnabled) return;
        
        try {
          this.recognition.start();
          this.isListening = true;
          this.updateListeningUI(true);
        } catch (error) {
          console.error('Failed to start recognition:', error);
          this.showPermissionError();
        }
      }

      stopListening() {
        if (this.recognition && this.isListening) {
          this.recognition.stop();
          this.isListening = false;
          this.updateListeningUI(false);
        }
      }

      toggleListening() {
        if (this.isListening) {
          this.stopListening();
        } else {
          this.startListening();
        }
      }

      onSpeechResult(transcript) {
        if (!transcript || transcript.trim().length === 0) return;
        
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
          chatInput.value = transcript;
          chatInput.style.height = 'auto';
          chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
          chatInput.focus();
          updateSendButton();
          
          if (this.autoSendEnabled && transcript.trim().length > 0 && transcript.trim().length < 50) {
            setTimeout(() => {
              sendMessage();
            }, 800);
          }
        }
        
        this.showTranscriptFeedback(transcript);
      }

      updateListeningUI(isListening) {
        const micBtn = document.getElementById('voiceBtn');
        const indicator = document.getElementById('listeningIndicator');
        
        if (micBtn) {
          if (isListening) {
            micBtn.classList.add('listening');
            micBtn.innerHTML = '<i class="fas fa-stop"></i>';
            micBtn.title = 'Click to stop listening';
          } else {
            micBtn.classList.remove('listening');
            micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            micBtn.title = 'Click to speak';
          }
        }
        
        if (indicator) {
          if (isListening) {
            indicator.classList.add('active');
            indicator.onclick = () => this.stopListening();
          } else {
            indicator.classList.remove('active');
            indicator.onclick = null;
          }
        }
      }

      showTranscriptFeedback(transcript) {
        const feedback = document.createElement('div');
        feedback.className = 'transcript-feedback';
        feedback.innerHTML = `
          <div class="transcript-text">
            <i class="fas fa-check-circle"></i>
            <span>Heard: "<strong>${transcript}</strong>"</span>
          </div>
        `;
        
        const chatContainer = document.querySelector('.main-content') || document.body;
        chatContainer.appendChild(feedback);
        
        setTimeout(() => {
          feedback.classList.add('fade-out');
          setTimeout(() => feedback.remove(), 500);
        }, 3000);
      }

      speakText(text, lang = null) {
        if (!this.speechSynthesis || !text || this.isSpeaking || !this.ttsEnabled) return;
        
        this.stopSpeaking();
        
        const utterance = new SpeechSynthesisUtterance(text);
        
        if (lang) {
          utterance.lang = lang;
        } else {
          utterance.lang = this.currentLanguage;
        }
        
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        const targetLang = lang || this.currentLanguage;
        const langPrefix = targetLang.split('-')[0];
        const preferredVoice = this.supportedVoices.find(v => v.lang.startsWith(langPrefix));
        
        if (preferredVoice) {
          utterance.voice = preferredVoice;
        }
        
        utterance.onstart = () => {
          this.isSpeaking = true;
          this.updateSpeakingUI(true);
        };
        
        utterance.onend = () => {
          this.isSpeaking = false;
          this.updateSpeakingUI(false);
        };
        
        utterance.onerror = (event) => {
          console.error('Speech synthesis error:', event);
          this.isSpeaking = false;
          this.updateSpeakingUI(false);
        };
        
        this.speechSynthesis.speak(utterance);
      }

      stopSpeaking() {
        if (this.speechSynthesis && this.isSpeaking) {
          this.speechSynthesis.cancel();
          this.isSpeaking = false;
          this.updateSpeakingUI(false);
        }
      }

      updateSpeakingUI(isSpeaking, messageElement = null) {
        document.querySelectorAll('.tts-btn').forEach(btn => {
          btn.classList.remove('speaking');
          btn.innerHTML = '<i class="fas fa-volume-up"></i>';
          btn.title = 'Listen to this response';
        });
        
        if (isSpeaking && messageElement) {
          const ttsBtn = messageElement.querySelector('.tts-btn');
          if (ttsBtn) {
            ttsBtn.classList.add('speaking');
            ttsBtn.innerHTML = '<i class="fas fa-stop"></i>';
            ttsBtn.title = 'Stop speaking';
          }
        }
      }

      showBrowserCompatibilityWarning() {
        console.warn('Voice features not supported in this browser');
        const voiceBtn = document.getElementById('voiceBtn');
        if (voiceBtn) {
          voiceBtn.classList.add('disabled');
          voiceBtn.title = 'Voice not supported in your browser';
          voiceBtn.onclick = null;
        }
      }

      showPermissionError() {
        const feedback = document.createElement('div');
        feedback.className = 'transcript-feedback';
        feedback.style.background = 'rgba(220, 38, 38, 0.95)';
        feedback.innerHTML = `
          <div class="transcript-text">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Microphone permission denied. Please allow microphone access in your browser settings.</span>
          </div>
        `;
        
        const chatContainer = document.querySelector('.main-content') || document.body;
        chatContainer.appendChild(feedback);
        
        setTimeout(() => {
          feedback.classList.add('fade-out');
          setTimeout(() => feedback.remove(), 500);
        }, 5000);
      }
    }

    // ORIGINAL CHATBOT CODE WITH VOICE INTEGRATION
    let voiceAssistant = null;
    let currentSessionId = null;
    let isFirstMessage = true;
    let messages = [];
    let isProcessing = false;

    const welcomeCenter = document.getElementById('welcomeCenter');
    const messagesContainer = document.getElementById('messagesContainer');
    const messagesArea = document.getElementById('messages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const voiceSettingsPanel = document.getElementById('voiceSettingsPanel');

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Farm Assistant initialized');
      
      currentSessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      console.log('Session ID:', currentSessionId);
      
      initializeVoiceAssistant();
      setupEventListeners();
      initializeInput();
      
      const presetQuery = sessionStorage.getItem('preset_chat_query');
      if (presetQuery) {
        setTimeout(() => {
          startChatWithMessage(presetQuery);
          sessionStorage.removeItem('preset_chat_query');
        }, 500);
      }
    });

    function initializeVoiceAssistant() {
      voiceAssistant = new VoiceAssistant();
      
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        voiceBtn.classList.add('disabled');
        voiceBtn.title = 'Voice not supported in your browser';
      }
      
      const userLanguage = localStorage.getItem('user_language') || 'en';
      voiceAssistant.setLanguage(userLanguage);
    }

    function setupEventListeners() {
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        updateSendButton();
      });

      document.getElementById('voiceInputToggle').addEventListener('change', function() {
        voiceAssistant.voiceEnabled = this.checked;
        voiceAssistant.saveVoiceSettings();
      });
      
      document.getElementById('ttsToggle').addEventListener('change', function() {
        voiceAssistant.ttsEnabled = this.checked;
        voiceAssistant.saveVoiceSettings();
      });
      
      document.getElementById('autoSendToggle').addEventListener('change', function() {
        voiceAssistant.autoSendEnabled = this.checked;
        voiceAssistant.saveVoiceSettings();
      });

      setTimeout(() => {
        chatInput.focus();
      }, 100);
    }

    function toggleVoiceInput() {
      if (voiceAssistant && voiceAssistant.voiceEnabled) {
        voiceAssistant.toggleListening();
      }
    }

    function toggleVoiceSettings() {
      voiceSettingsPanel.classList.toggle('hidden');
    }

    function initializeInput() {
      chatInput.style.height = '56px';
      chatInput.style.minHeight = '56px';
      updateSendButton();
    }

    function updateSendButton() {
      const hasText = chatInput.value.trim().length > 0;
      sendBtn.disabled = !hasText || isProcessing;
      sendBtn.style.opacity = hasText && !isProcessing ? '1' : '0.5';
      sendBtn.style.cursor = hasText && !isProcessing ? 'pointer' : 'not-allowed';
    }

    function startQuickChat(prompt) {
      console.log('Quick chat:', prompt.substring(0, 50) + '...');
      startChatWithMessage(prompt);
    }

    function startChatWithMessage(message) {
      if (!message || !message.trim()) return;
      
      if (isFirstMessage) {
        welcomeCenter.classList.add('hidden');
        messagesContainer.classList.remove('hidden');
        isFirstMessage = false;
      }
      
      addMessageToUI(message, 'user');
      processAIResponse(message);
    }

    async function sendMessage() {
      const message = chatInput.value.trim();
      
      if (!message || isProcessing) return;
      
      startChatWithMessage(message);
      
      chatInput.value = '';
      initializeInput();
      chatInput.focus();
    }

    function addMessageToUI(content, role) {
      const messageRow = document.createElement('div');
      messageRow.className = `message-row ${role}`;
      
      const messageBubble = document.createElement('div');
      messageBubble.className = `message-bubble ${role === 'user' ? 'user-message' : 'bot-message'}`;
      
      const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
      const name = role === 'user' ? 'You' : 'Farm Assistant';
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      let messageHTML = `
        <div class="message-header">
          <div class="avatar ${role}">${avatar}</div>
          <span class="text-sm font-semibold ${role === 'user' ? 'text-green-800' : 'text-gray-700'}">${name}</span>
        </div>
        <div class="message-content">${formatMessageContent(content)}</div>
        <div class="timestamp">${time}</div>
      `;
      
      messageBubble.innerHTML = messageHTML;
      messageRow.appendChild(messageBubble);
      
      if (role === 'assistant') {
        const ttsBtn = document.createElement('button');
        ttsBtn.className = 'tts-btn';
        ttsBtn.title = 'Listen to this response';
        ttsBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        
        ttsBtn.onclick = (e) => {
          e.stopPropagation();
          
          if (voiceAssistant && voiceAssistant.isSpeaking) {
            voiceAssistant.stopSpeaking();
            ttsBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            ttsBtn.title = 'Listen to this response';
            ttsBtn.classList.remove('speaking');
          } else {
            speakMessage(content, messageRow);
            ttsBtn.innerHTML = '<i class="fas fa-stop"></i>';
            ttsBtn.title = 'Stop speaking';
          }
        };
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions';
        actionsDiv.appendChild(ttsBtn);
        
        messageBubble.appendChild(actionsDiv);
      }
      
      messagesArea.appendChild(messageRow);
      
      messages.push({ 
        content, 
        role, 
        timestamp: new Date().toISOString(),
        session: currentSessionId 
      });
      
      // NO AUTO-SPEAK - User must click speaker icon manually
      
      setTimeout(() => {
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }, 50);
    }

    function speakMessage(text, messageElement = null) {
      if (voiceAssistant) {
        voiceAssistant.speakText(text);
        if (messageElement) {
          voiceAssistant.updateSpeakingUI(true, messageElement);
        }
      }
    }

    function formatMessageContent(content) {
      return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>')
        .replace(/^- (.*?)(?=\n|$)/gm, '‚Ä¢ $1<br>')
        .replace(/(\d+)\. (.*?)(?=\n|$)/gm, '$1. $2<br>');
    }

    function showTypingIndicator() {
      const messageRow = document.createElement('div');
      messageRow.className = 'message-row assistant';
      messageRow.id = 'typingIndicator';
      
      const messageBubble = document.createElement('div');
      messageBubble.className = 'message-bubble bot-message';
      
      messageBubble.innerHTML = `
        <div class="message-header">
          <div class="avatar bot">ü§ñ</div>
          <span class="text-sm font-semibold text-gray-700">Farm Assistant</span>
        </div>
        <div class="typing-indicator">
          <span class="text-gray-600 mr-2">Thinking</span>
          <div class="typing-dot"></div>
          <div class="typing-dot" style="animation-delay: 0.2s"></div>
          <div class="typing-dot" style="animation-delay: 0.4s"></div>
        </div>
      `;
      
      messageRow.appendChild(messageBubble);
      messagesArea.appendChild(messageRow);
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    async function processAIResponse(message) {
      isProcessing = true;
      updateSendButton();
      
      showTypingIndicator();
      
      try {
        console.log('Processing:', message.substring(0, 50) + '...');
        
        const userContext = getUserContext();
        const enhancedMessage = enhancePrompt(message);
        
        const response = await fetch('/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ 
            message: enhancedMessage,
            session_id: currentSessionId,
            user_context: userContext
          })
        });

        hideTypingIndicator();
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log('‚úÖ Received AI response');
            const completeResponse = ensureCompleteResponse(data.reply, message);
            addMessageToUI(completeResponse, 'assistant');
          } else {
            console.error('‚ùå API error:', data.message);
            addMessageToUI(getDetailedFallbackResponse(message), 'assistant');
          }
        } else {
          console.error('‚ùå HTTP error:', response.status);
          addMessageToUI(getDetailedFallbackResponse(message), 'assistant');
        }
        
      } catch (error) {
        hideTypingIndicator();
        console.error('‚ùå Network error:', error);
        addMessageToUI(getDetailedFallbackResponse(message), 'assistant');
      } finally {
        isProcessing = false;
        updateSendButton();
      }
    }

    function enhancePrompt(message) {
      const lower = message.toLowerCase();
      
      if (lower.includes('crop') && lower.includes('season')) {
        return message + " Please include sowing time, duration, yield expectations, and suitable varieties.";
      }
      else if (lower.includes('fertilizer')) {
        return message + " Please provide NPK ratio, quantity per acre, application schedule, and recommended brands.";
      }
      else if (lower.includes('pest') || lower.includes('disease')) {
        return message + " Include both preventive measures and treatment methods, with organic options if available.";
      }
      else if (lower.includes('irrigation') || lower.includes('water')) {
        return message + " Provide schedule, water requirements per acre, and efficiency tips.";
      }
      else if (lower.includes('weather') || lower.includes('rain')) {
        return message + " Include impact on farming activities and precautions to take.";
      }
      else if (lower.includes('soil') || lower.includes('land')) {
        return message + " Include soil preparation methods and improvement techniques.";
      }
      
      return message + " Please provide detailed, practical information suitable for farmers.";
    }

    function ensureCompleteResponse(response, originalQuery) {
      const lowerQuery = originalQuery.toLowerCase();
      const lowerResponse = response.toLowerCase();
      
      if (response.length < 100 && !lowerResponse.includes('?') && !lowerResponse.includes('.')) {
        return response + "\n\nFor more detailed information, please visit our specialized pages or ask a more specific question.";
      }
      
      if (lowerQuery.includes('crop') && !lowerResponse.includes('yield') && !lowerResponse.includes('harvest')) {
        return response + "\n\nüåæ **Additional Tips:**\n‚Ä¢ Monitor soil moisture regularly\n‚Ä¢ Check for pest infestation weekly\n‚Ä¢ Maintain proper plant spacing\n‚Ä¢ Test soil nutrients before sowing";
      }
      
      if (lowerQuery.includes('fertilizer') && !lowerResponse.includes('apply') && !lowerResponse.includes('schedule')) {
        return response + "\n\nüå± **Application Tips:**\n‚Ä¢ Apply fertilizers in the evening\n‚Ä¢ Water immediately after application\n‚Ä¢ Avoid application before heavy rain\n‚Ä¢ Use soil testing for precise needs";
      }
      
      return response;
    }

    function getUserContext() {
      try {
        const location = localStorage.getItem('user_location');
        const crop = localStorage.getItem('primary_crop');
        const soil = localStorage.getItem('soil_type');
        
        if (location || crop || soil) {
          return {
            location: location || 'Unknown location',
            crop: crop || 'General farming',
            soil_type: soil || 'Various soil types',
            irrigation: localStorage.getItem('irrigation_type') || 'Not specified'
          };
        }
        return null;
      } catch (error) {
        return null;
      }
    }

    function getDetailedFallbackResponse(message) {
      const lower = message.toLowerCase();
      
      if (lower.includes('weather')) {
        return `**Weather Information:**\n\n‚Ä¢ Check the Weather page for real-time agricultural weather forecasts\n‚Ä¢ Monitor rainfall patterns for irrigation planning\n‚Ä¢ Protect crops from extreme temperatures with shade/cover\n‚Ä¢ Ideal farming temperature: 20-30¬∞C\n‚Ä¢ Rain requirement: 500-1000mm annually for most crops\n\n**Action:** Visit Weather page for detailed forecasts and farming advisories.`;
      } 
      else if (lower.includes('fertilizer') || lower.includes('npk')) {
        return `**Fertilizer Guidance:**\n\n‚Ä¢ General NPK ratio for most crops: 4:2:1 (N:P:K)\n‚Ä¢ Apply 100-150 kg/acre for cereal crops\n‚Ä¢ Split application: 50% basal, 25% at 30 days, 25% at 60 days\n‚Ä¢ Organic alternatives: Vermicompost (2-3 tonnes/acre), Farmyard manure (5-10 tonnes/acre)\n‚Ä¢ Always conduct soil test before application\n\n**Recommendation:** Use the Fertilizer page for personalized recommendations based on your crop and soil.`;
      }
      else if (lower.includes('pest') || lower.includes('insect')) {
        return `**Pest Control Methods:**\n\n**Preventive Measures:**\n‚Ä¢ Crop rotation every season\n‚Ä¢ Maintain field sanitation\n‚Ä¢ Use resistant varieties\n‚Ä¢ Proper spacing for air circulation\n\n**Organic Treatments:**\n‚Ä¢ Neem oil spray: 5ml per liter water (weekly)\n‚Ä¢ Garlic-chilli spray for chewing insects\n‚Ä¢ Yellow sticky traps for flying pests\n‚Ä¢ Biological control: Ladybugs for aphids\n\n**Chemical (if severe):**\n‚Ä¢ Imidacloprid for sucking pests\n‚Ä¢ Chlorpyriphos for soil insects\n‚Ä¢ Always follow recommended dosage`;
      }
      else if (lower.includes('irrigation') || lower.includes('water')) {
        return `**Irrigation Management:**\n\n**Methods (Most efficient first):**\n1. Drip irrigation - Saves 30-50% water\n2. Sprinkler irrigation - Good for light soils\n3. Furrow irrigation - Traditional, less efficient\n\n**Water Requirements:**\n‚Ä¢ Rice: 1200-1500mm (standing water)\n‚Ä¢ Wheat: 450-650mm (4-6 irrigations)\n‚Ä¢ Vegetables: 500-800mm (frequent light irrigation)\n\n**Best Practices:**\n‚Ä¢ Irrigate early morning (5-8 AM)\n‚Ä¢ Monitor soil moisture at 15cm depth\n‚Ä¢ Mulch to reduce evaporation\n‚Ä¢ Use rainwater harvesting`;
      }
      else if (lower.includes('crop') && lower.includes('season')) {
        return `**Seasonal Crop Calendar:**\n\n**KHARIF (June-September):**\n‚Ä¢ Rice: June-July sowing, Oct-Nov harvest\n‚Ä¢ Maize: June-July sowing, Sep-Oct harvest\n‚Ä¢ Cotton: May-June sowing, Dec-Jan harvest\n‚Ä¢ Soybean: June-July sowing, Sep-Oct harvest\n\n**RABI (October-March):**\n‚Ä¢ Wheat: Nov-Dec sowing, Mar-Apr harvest\n‚Ä¢ Chickpea: Oct-Nov sowing, Feb-Mar harvest\n‚Ä¢ Mustard: Oct-Nov sowing, Feb-Mar harvest\n‚Ä¢ Barley: Oct-Nov sowing, Mar-Apr harvest\n\n**Yield Expectations:**\n‚Ä¢ Rice: 25-30 quintals/acre\n‚Ä¢ Wheat: 20-25 quintals/acre\n‚Ä¢ Vegetables: 80-120 quintals/acre`;
      }
      else {
        return `I can help with detailed farming information about:\n\nüåæ **Crop Management:** Selection, sowing, harvesting\nüå± **Fertilizers:** NPK ratios, organic options, application\nüêõ **Pest Control:** Prevention, organic treatments\nüíß **Irrigation:** Methods, scheduling, water conservation\nüå§Ô∏è **Weather:** Impact on farming, precautions\nüí∞ **Economics:** Costs, market prices, profitability\n\n**For specific advice:** Please ask detailed questions or visit our specialized pages for Weather, Fertilizer, and Market information.`;
      }
    }

    function suggestPrompt(type) {
      const prompts = {
        weather: "What's the weather forecast for farming this week? Include rainfall predictions and temperature ranges.",
        fertilizer: "What NPK fertilizer should I use for vegetable crops? Include quantity per acre and application timing.",
        pest: "How to control common pests in tomato crops? List organic and chemical options.",
        irrigation: "What's the best irrigation schedule for wheat crop? Include water requirements per acre."
      };
      
      if (prompts[type]) {
        chatInput.value = prompts[type];
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
        updateSendButton();
        chatInput.focus();
      }
    }

    function clearChat() {
      if (messages.length === 0 && isFirstMessage) {
        return;
      }
      
      if (confirm('Clear all messages in this chat?')) {
        messages = [];
        messagesArea.innerHTML = '';
        welcomeCenter.classList.remove('hidden');
        messagesContainer.classList.add('hidden');
        isFirstMessage = true;
        chatInput.value = '';
        initializeInput();
        chatInput.focus();
        
        if (voiceAssistant) {
          voiceAssistant.stopSpeaking();
        }
        
        currentSessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('üÜï New session:', currentSessionId);
      }
    }

    function exportChat() {
      if (messages.length === 0) {
        alert('No messages to export');
        return;
      }
      
      let exportText = `Farm Assistant Chat - ${new Date().toLocaleString()}\n\n`;
      
      messages.forEach(msg => {
        const role = msg.role === 'user' ? 'You' : 'Assistant';
        const time = new Date(msg.timestamp).toLocaleTimeString();
        exportText += `${role} (${time}):\n${msg.content}\n\n`;
      });
      
      const blob = new Blob([exportText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `farm-chat-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('Chat exported successfully!');
    }

    window.startQuickChat = startQuickChat;
    window.sendMessage = sendMessage;
    window.suggestPrompt = suggestPrompt;
    window.clearChat = clearChat;
    window.exportChat = exportChat;
    window.toggleVoiceInput = toggleVoiceInput;
    window.toggleVoiceSettings = toggleVoiceSettings;
  </script>
</body>
</html>