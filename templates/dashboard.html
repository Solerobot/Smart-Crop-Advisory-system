<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}{{ t('dashboard', user_language) }} - {{ t('app_name', user_language) }}{% endblock %}

{% block styles %}
<style>
    /* Color Palette */
    :root {
        --leaf-green: #16a34a;
        --fresh-green: #22c55e;
        --sky-blue: #0ea5e9;
        --water-blue: #3b82f6;
        --sun-yellow: #eab308;
    }
    
    .bg-leaf { background-color: var(--leaf-green); }
    .bg-sky { background-color: var(--sky-blue); }
    .bg-sun { background-color: var(--sun-yellow); }
    
    .text-leaf { color: var(--leaf-green); }
    .text-sky { color: var(--sky-blue); }
    .text-sun { color: var(--sun-yellow); }
    
    .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .transition-smooth {
        transition: all 0.2s ease-in-out;
    }
    
    .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #16a34a;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden">
    <div class="text-center">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-gray-600">{{ t('loading_dashboard', user_language) }}</p>
    </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full card-shadow">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">{{ t('complete_profile', user_language) }}</h2>
                <button onclick="hideProfileModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="profileForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-map-marker-alt text-sky mr-2"></i>
                            {{ t('location', user_language) }}
                        </label>
                        
                        <!-- State Dropdown -->
                        <select id="stateSelect" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-leaf focus:border-leaf outline-none"
                                onchange="loadDistricts(this.value)"
                                required>
                            <option value="">{{ t('select_state', user_language) }}</option>
                            <!-- States will be loaded dynamically -->
                        </select>
                        
                        <!-- District Dropdown -->
                        <select id="districtSelect" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-leaf focus:border-leaf outline-none"
                                disabled
                                required>
                            <option value="">{{ t('select_district', user_language) }}</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-ruler text-sun mr-2"></i>
                            {{ t('farm_size', user_language) }} (acres)
                        </label>
                        <input type="number" id="farmSize" min="0.5" step="0.1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-leaf focus:border-leaf outline-none"
                               placeholder="{{ t('farm_size_placeholder', user_language) }}" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-seedling text-leaf mr-2"></i>
                            {{ t('primary_crop', user_language) }}
                        </label>
                        <select id="primaryCrop" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-leaf focus:border-leaf outline-none" required>
                            <option value="">{{ t('select_crop', user_language) }}</option>
                            <!-- Cereals -->
                            <optgroup label="{{ t('crop_category_cereals', user_language) }}">
                                <option>Rice</option>
                                <option>Wheat</option>
                                <option>Maize</option>
                                <option>Barley</option>
                                <option>Millets</option>
                            </optgroup>
                            <!-- Pulses -->
                            <optgroup label="{{ t('crop_category_pulses', user_language) }}">
                                <option>Chickpea (Chana)</option>
                                <option>Pigeon Pea (Tur/Arhar)</option>
                                <option>Black Gram (Urad)</option>
                                <option>Green Gram (Moong)</option>
                            </optgroup>
                            <!-- Cash Crops -->
                            <optgroup label="{{ t('crop_category_cash', user_language) }}">
                                <option>Cotton</option>
                                <option>Sugarcane</option>
                                <option>Jute</option>
                            </optgroup>
                            <!-- Vegetables -->
                            <optgroup label="{{ t('crop_category_vegetables', user_language) }}">
                                <option>Tomato</option>
                                <option>Potato</option>
                                <option>Onion</option>
                                <option>Brinjal (Eggplant)</option>
                            </optgroup>
                            <!-- Fruits -->
                            <optgroup label="{{ t('crop_category_fruits', user_language) }}">
                                <option>Mango</option>
                                <option>Banana</option>
                                <option>Orange</option>
                                <option>Guava</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Additional Fields -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-droplet text-water-blue mr-2"></i>
                            {{ t('irrigation_type', user_language) }}
                        </label>
                        <select id="irrigationType" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-leaf focus:border-leaf outline-none">
                            <option value="">{{ t('select_irrigation', user_language) }}</option>
                            <option>{{ t('irrigation_drip', user_language) }}</option>
                            <option>{{ t('irrigation_sprinkler', user_language) }}</option>
                            <option>{{ t('irrigation_flood', user_language) }}</option>
                            <option>{{ t('irrigation_manual', user_language) }}</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-mountain text-leaf mr-2"></i>
                            {{ t('soil_type', user_language) }}
                        </label>
                        <select id="soilType" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-leaf focus:border-leaf outline-none">
                            <option value="">{{ t('select_soil', user_language) }}</option>
                            <option>{{ t('soil_clay', user_language) }}</option>
                            <option>{{ t('soil_loam', user_language) }}</option>
                            <option>{{ t('soil_sandy', user_language) }}</option>
                            <option>{{ t('soil_silt', user_language) }}</option>
                            <option>{{ t('soil_red', user_language) }}</option>
                            <option>{{ t('soil_black', user_language) }}</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button type="submit" 
                            id="saveProfileBtn"
                            class="w-full bg-leaf text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-smooth flex items-center justify-center">
                        <span id="saveProfileText">{{ t('save_profile', user_language) }}</span>
                        <div id="saveProfileSpinner" class="hidden ml-2">
                            <div class="spinner"></div>
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Weather Alert Banner -->
<div id="weatherAlert" class="hidden fixed top-4 right-4 left-4 md:left-auto md:right-4 md:w-96 z-40">
    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg card-shadow">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800" id="alertTitle">{{ t('weather_alert', user_language) }}</h3>
                <div class="mt-1 text-sm text-red-700" id="alertMessage"></div>
                <div class="mt-2">
                    <a href="#weather" class="text-xs font-medium text-red-800 hover:text-red-900">
                        {{ t('view_details', user_language) }} →
                    </a>
                </div>
            </div>
            <button onclick="hideWeatherAlert()" class="ml-auto pl-3">
                <i class="fas fa-times text-red-400 hover:text-red-600"></i>
            </button>
        </div>
    </div>
</div>

<!-- Main Dashboard -->
<div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
        <!-- Logo -->
        <div class="p-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-leaf rounded-lg flex items-center justify-center">
                    <i class="fas fa-leaf text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">{{ t('app_name_short', user_language) }}</h1>
                    <p class="text-xs text-gray-500">{{ t('app_name_suffix', user_language) }}</p>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="flex-1 px-3">
            <ul class="space-y-1">
                <li>
                    <a href="/" class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-home w-5"></i>
                        <span>{{ t('home', user_language) }}</span>
                    </a>
                </li>
                <li>
                    <a href="dashboard.html" class="flex items-center space-x-3 px-3 py-2.5 bg-leaf text-white rounded-lg">
                        <i class="fas fa-tachometer-alt w-5"></i>
                        <span>{{ t('dashboard', user_language) }}</span>
                    </a>
                </li>
                <li>
                    <a href="weather.html" class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-cloud-sun w-5"></i>
                        <span>{{ t('weather', user_language) }}</span>
                    </a>
                </li>
                <li>
                    <a href="chatbot.html" class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-comments w-5"></i>
                        <span>{{ t('chatbot', user_language) }}</span>
                    </a>
                </li>
                <li>
                    <button onclick="showProfileModal()" class="w-full flex items-center space-x-3 px-3 py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg text-left">
                        <i class="fas fa-user-edit w-5"></i>
                        <span>{{ t('edit_profile', user_language) }}</span>
                    </button>
                </li>
            </ul>
        </nav>
        
        <!-- User Info -->
        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-sky rounded-full flex items-center justify-center">
                    <span class="text-white font-semibold" id="userInitial">U</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-800 truncate" id="userName">{{ t('loading', user_language) }}</div>
                    <div class="text-xs text-gray-500 truncate" id="userLocation">{{ t('location', user_language) }}</div>
                </div>
                <button onclick="logout()" class="p-1.5 text-gray-400 hover:text-red-500">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 id="welcomeMessage" class="text-xl font-bold text-gray-800">{{ t('welcome', user_language) }}</h2>
                    <p id="userStats" class="text-sm text-gray-600">{{ t('loading_profile', user_language) }}</p>
                </div>
                <div class="flex space-x-2">
                    <a href="weather.html" class="px-4 py-2 bg-sky text-white rounded-lg hover:bg-blue-600 transition-smooth text-sm">
                        <i class="fas fa-cloud-sun mr-1"></i>{{ t('full_weather', user_language) }}
                    </a>
                    <a href="chatbot.html" class="px-4 py-2 bg-leaf text-white rounded-lg hover:bg-green-700 transition-smooth text-sm">
                        <i class="fas fa-plus mr-1"></i>{{ t('new_chat', user_language) }}
                    </a>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="p-6">
            <!-- Stats Cards - 3 COLUMNS -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Weather Card -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 card-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-800">{{ t('weather', user_language) }}</h3>
                            <p id="weatherLocation" class="text-xs text-gray-500">{{ t('your_location', user_language) }}</p>
                        </div>
                        <i class="fas fa-sun text-sun text-xl" id="weatherIcon"></i>
                    </div>
                    <div>
                        <div id="weatherTemp" class="text-2xl font-bold text-gray-800">--°C</div>
                        <p id="weatherCondition" class="text-sm text-gray-600 mt-1">--</p>
                        <div class="flex space-x-4 mt-3 text-xs text-gray-500">
                            <div>
                                <i class="fas fa-tint mr-1"></i>
                                <span id="weatherHumidity">--%</span>
                            </div>
                            <div>
                                <i class="fas fa-wind mr-1"></i>
                                <span id="weatherWind">-- km/h</span>
                            </div>
                            <div>
                                <i class="fas fa-thermometer-half mr-1"></i>
                                <span id="weatherFeelsLike">--°C</span>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                            <a href="weather.html" class="text-leaf hover:text-green-700 text-xs font-medium">
                                <i class="fas fa-external-link-alt mr-1"></i>{{ t('full_forecast', user_language) }}
                            </a>
                            <button onclick="refreshWeather()" 
                                    class="text-gray-500 hover:text-leaf text-xs font-medium transition-smooth flex items-center"
                                    id="refreshButton">
                                <i class="fas fa-sync-alt mr-1"></i>
                                <span>{{ t('refresh', user_language) }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Market Card -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 card-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-800">{{ t('market_price', user_language) }}</h3>
                            <p id="marketCrop" class="text-xs text-gray-500">{{ t('current_rate', user_language) }}</p>
                        </div>
                        <i class="fas fa-chart-line text-sky text-xl"></i>
                    </div>
                    <div>
                        <div id="marketPrice" class="text-2xl font-bold text-gray-800">₹ --</div>
                        <p class="text-sm text-gray-600 mt-1">{{ t('per_quintal', user_language) }}</p>
                        <div id="marketTrendContainer" class="inline-flex items-center mt-3 px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs hidden">
                            <i class="fas fa-arrow-up mr-1"></i>
                            <span id="marketTrend">{{ t('loading', user_language) }}</span>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <button onclick="refreshMarketData()" class="w-full text-leaf hover:text-green-700 text-xs font-medium flex items-center justify-center">
                                <i class="fas fa-sync-alt mr-1"></i>{{ t('update_market', user_language) }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Fertilizer Card -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 card-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-800">{{ t('fertilizer', user_language) }}</h3>
                            <p id="fertilizerCrop" class="text-xs text-gray-500">{{ t('recommendation', user_language) }}</p>
                        </div>
                        <i class="fas fa-flask text-leaf text-xl"></i>
                    </div>
                    <div>
                        <div id="fertilizerNPK" class="text-lg font-bold text-gray-800">{{ t('npk_label', user_language) }}: --</div>
                        <p id="fertilizerQuantity" class="text-sm text-gray-600 mt-1">-- kg/acre</p>
                        <div id="fertilizerCost" class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-rupee-sign mr-1"></i>
                            <span>{{ t('estimated_label', user_language) }}: <span id="fertilizerCostText">--</span></span>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <button onclick="viewFertilizerDetails()" class="w-full text-leaf hover:text-green-700 text-xs font-medium">
                                <i class="fas fa-info-circle mr-1"></i>{{ t('view_details', user_language) }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Farming Tasks -->
            <div class="mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">{{ t('quick_farming_advice', user_language) }}</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="goToChatWithText('What are the best practices for soil preparation for ' + (localStorage.getItem('primary_crop') || 'my crops') + '? Please provide step-by-step guidance.')" 
                            class="bg-white border border-gray-200 rounded-lg p-3 hover:border-leaf hover:bg-green-50 transition-smooth text-left">
                        <div class="text-leaf text-lg mb-1">
                            <i class="fas fa-tractor"></i>
                        </div>
                        <div class="font-medium text-gray-800 text-sm">{{ t('soil_preparation', user_language) }}</div>
                        <div class="text-xs text-gray-500 mt-1">{{ t('soil_preparation_desc', user_language) }}</div>
                    </button>
                    
                    <button onclick="goToChatWithText('How to identify nutrient deficiencies in ' + (localStorage.getItem('primary_crop') || 'my crops') + '? What are the symptoms and remedies?')" 
                            class="bg-white border border-gray-200 rounded-lg p-3 hover:border-leaf hover:bg-green-50 transition-smooth text-left">
                        <div class="text-leaf text-lg mb-1">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="font-medium text-gray-800 text-sm">{{ t('nutrient_check', user_language) }}</div>
                        <div class="text-xs text-gray-500 mt-1">{{ t('nutrient_check_desc', user_language) }}</div>
                    </button>
                    
                    <button onclick="goToChatWithText('What are common diseases in ' + (localStorage.getItem('primary_crop') || 'my crops') + ' and their treatments? Include organic options if available.')" 
                            class="bg-white border border-gray-200 rounded-lg p-3 hover:border-leaf hover:bg-green-50 transition-smooth text-left">
                        <div class="text-leaf text-lg mb-1">
                            <i class="fas fa-bug"></i>
                        </div>
                        <div class="font-medium text-gray-800 text-sm">{{ t('disease_control', user_language) }}</div>
                        <div class="text-xs text-gray-500 mt-1">{{ t('disease_control_desc', user_language) }}</div>
                    </button>
                    
                    <button onclick="goToChatWithText('What are the best irrigation methods for ' + (localStorage.getItem('primary_crop') || 'my crops') + '? How to conserve water while maintaining yield?')" 
                            class="bg-white border border-gray-200 rounded-lg p-3 hover:border-leaf hover:bg-green-50 transition-smooth text-left">
                        <div class="text-leaf text-lg mb-1">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="font-medium text-gray-800 text-sm">{{ t('irrigation', user_language) }}</div>
                        <div class="text-xs text-gray-500 mt-1">{{ t('irrigation_desc', user_language) }}</div>
                    </button>
                </div>
            </div>

            <!-- Recent Activity & Updates -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Recent Chats -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 card-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">{{ t('recent_chats', user_language) }}</h3>
                        <a href="chatbot.html" class="text-leaf hover:underline text-sm">{{ t('view_all', user_language) }}</a>
                    </div>
                    <div id="recentChats" class="space-y-3">
                        <div class="text-center py-4 text-gray-400">
                            <i class="fas fa-comment-dots text-xl mb-2"></i>
                            <p class="text-sm">{{ t('no_chats', user_language) }}</p>
                            <a href="chatbot.html" class="text-leaf text-xs hover:underline mt-1 inline-block">{{ t('start_conversation', user_language) }}</a>
                        </div>
                    </div>
                </div>

                <!-- Farm Updates -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 card-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">{{ t('farm_updates', user_language) }}</h3>
                        <button onclick="loadFarmUpdates()" class="text-leaf hover:underline text-sm flex items-center">
                            <i class="fas fa-sync-alt mr-1"></i> {{ t('refresh', user_language) }}
                        </button>
                    </div>
                    <div class="space-y-3" id="farmUpdates">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <i class="fas fa-cloud-rain text-blue-500"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800 text-sm">{{ t('weather_alert', user_language) }}</div>
                                <div class="text-xs text-gray-500">{{ t('loading_weather_alerts', user_language) }}</div>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <i class="fas fa-calendar-alt text-green-500"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800 text-sm">{{ t('seasonal_reminder', user_language) }}</div>
                                <div class="text-xs text-gray-500">{{ t('loading_seasonal_info', user_language) }}</div>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800 text-sm">{{ t('pest_watch', user_language) }}</div>
                                <div class="text-xs text-gray-500">{{ t('monitoring_crop_health', user_language) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ========== CONFIGURATION ==========
    const API_BASE = 'http://localhost:5001';
    
    // ========== TRANSLATIONS FOR JAVASCRIPT ==========
    window.dashboardTranslations = {
        greeting_morning: "{{ t('greeting_morning', user_language) }}",
        greeting_afternoon: "{{ t('greeting_afternoon', user_language) }}",
        greeting_evening: "{{ t('greeting_evening', user_language) }}",
        loading: "{{ t('loading', user_language) }}",
        saving: "{{ t('saving', user_language) }}",
        updated: "{{ t('updated', user_language) }}",
        failed: "{{ t('failed', user_language) }}",
        refreshing: "{{ t('refreshing', user_language) }}",
        stable: "{{ t('trend_stable', user_language) }}",
        select_state: "{{ t('select_state', user_language) }}",
        select_district: "{{ t('select_district', user_language) }}",
        your_location: "{{ t('your_location', user_language) }}",
        current_rate: "{{ t('current_rate', user_language) }}",
        recommendation: "{{ t('recommendation', user_language) }}",
        profile_saved: "{{ t('profile_saved', user_language) }}",
        profile_saved_local: "{{ t('profile_saved_local', user_language) }}",
        required_fields: "{{ t('required_fields_error', user_language) }}",
        profile_save_error: "{{ t('profile_save_error', user_language) }}",
        weather_alert_heavy_rain: "{{ t('weather_alert_heavy_rain', user_language) }}",
        weather_alert_frost: "{{ t('weather_alert_frost', user_language) }}",
        weather_alert_heat_wave: "{{ t('weather_alert_heat_wave', user_language) }}",
        delay_field_work: "{{ t('delay_field_work', user_language) }}",
        protect_crops: "{{ t('protect_crops', user_language) }}",
        irrigate_crops: "{{ t('irrigate_crops', user_language) }}",
        view_details: "{{ t('view_details', user_language) }}"
    };
    
    // ========== AUTHENTICATION HELPERS ==========
    async function authFetch(url, options = {}) {
        try {
            const response = await fetch(`${API_BASE}${url}`, {
                ...options,
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...options.headers
                }
            });
            
            const finalUrl = response.url;
            if (finalUrl.includes('/login') || response.status === 401) {
                console.log('Authentication required or session expired');
                return {
                    ok: false,
                    status: 401,
                    json: async () => ({ error: 'Unauthorized' })
                };
            }
            
            return response;
        } catch (error) {
            console.error('Network error:', error);
            return {
                ok: false,
                status: 0,
                json: async () => ({ error: 'Network error' })
            };
        }
    }
    
    // ========== STATE/DISTRICT DATA ==========
    let stateDistricts = {};
    
    async function loadStateDistricts() {
        try {
            const response = await fetch(`${API_BASE}/states-districts.json`);
            if (response.ok) {
                const data = await response.json();
                stateDistricts = data;
                
                const stateSelect = document.getElementById('stateSelect');
                stateSelect.innerHTML = `<option value="">${window.dashboardTranslations.select_state}</option>`;
                
                Object.keys(stateDistricts).sort().forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });
            } else {
                loadFallbackStateDistricts();
            }
        } catch (error) {
            console.error('Error loading state districts:', error);
            loadFallbackStateDistricts();
        }
    }
    
    function loadFallbackStateDistricts() {
        stateDistricts = {
            "Andhra Pradesh": ["Visakhapatnam", "Vijayawada", "Guntur"],
            "Telangana": ["Hyderabad", "Warangal", "Karimnagar"],
            "Karnataka": ["Bengaluru", "Mysuru", "Hubli"],
            "Maharashtra": ["Mumbai", "Pune", "Nagpur"],
            "Tamil Nadu": ["Chennai", "Coimbatore", "Madurai"],
            "Uttar Pradesh": ["Lucknow", "Kanpur", "Varanasi"],
            "Punjab": ["Chandigarh", "Ludhiana", "Amritsar"],
            "Rajasthan": ["Jaipur", "Udaipur", "Jodhpur"],
            "Gujarat": ["Ahmedabad", "Surat", "Vadodara"],
            "West Bengal": ["Kolkata", "Howrah", "Durgapur"]
        };
        
        const stateSelect = document.getElementById('stateSelect');
        stateSelect.innerHTML = `<option value="">${window.dashboardTranslations.select_state}</option>`;
        
        Object.keys(stateDistricts).sort().forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
        });
    }
    
    function loadDistricts(selectedState) {
        const districtSelect = document.getElementById('districtSelect');
        districtSelect.innerHTML = `<option value="">${window.dashboardTranslations.select_district}</option>`;
        districtSelect.disabled = true;
        
        if (!selectedState || !stateDistricts[selectedState]) return;
        
        stateDistricts[selectedState].forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            districtSelect.appendChild(option);
        });
        
        districtSelect.disabled = false;
    }
    
    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        initDashboard();
    });
    
    async function initDashboard() {
        showLoading(true);
        
        try {
            await loadStateDistricts();
            
            try {
                const response = await authFetch('/check-auth');
                const data = await response.json();
                
                if (data.authenticated && data.user) {
                    updateUserInfo(data.user);
                    await loadDashboardData();
                    await loadMarketData();
                    await loadFertilizerData();
                    await loadFarmUpdates();
                    await checkProfileCompletion();
                } else {
                    loadFallbackData();
                }
            } catch (authError) {
                console.log('Auth check failed, using fallback:', authError);
                loadFallbackData();
            }
            
            await loadRealWeather();
            
            try {
                await loadRecentChats();
            } catch (chatError) {
                console.log('Could not load chats:', chatError);
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('Dashboard initialization error:', error);
            loadFallbackData();
            showLoading(false);
        }
    }
    
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.remove('hidden');
        } else {
            overlay.classList.add('hidden');
        }
    }
    
    // ========== USER INFO ==========
    function updateUserInfo(user) {
        document.getElementById('userName').textContent = user.username || 'User';
        document.getElementById('userInitial').textContent = user.username ? user.username.charAt(0).toUpperCase() : 'U';
        
        if (user.state && user.district) {
            const location = `${user.state}, ${user.district}`;
            document.getElementById('userLocation').textContent = location;
            document.getElementById('weatherLocation').textContent = location;
            localStorage.setItem('user_location', location);
        }
        
        const hour = new Date().getHours();
        let greeting = window.dashboardTranslations.greeting_morning;
        if (hour >= 12 && hour < 18) greeting = window.dashboardTranslations.greeting_afternoon;
        if (hour >= 18) greeting = window.dashboardTranslations.greeting_evening;
        
        document.getElementById('welcomeMessage').textContent = `${greeting}, ${user.username || 'User'}`;
        
        let stats = [];
        if (user.state && user.district) stats.push(`${user.state}, ${user.district}`);
        if (user.primary_crop) stats.push(user.primary_crop);
        if (user.farm_size) stats.push(`${user.farm_size} acres`);
        document.getElementById('userStats').textContent = stats.join(' • ') || window.dashboardTranslations.loading_profile;
    }
    
    // ========== MARKET DATA FROM LLM - FIXED ENDPOINT ==========
    async function loadMarketData() {
        try {
            const userCrop = localStorage.getItem('primary_crop') || 'Rice';
            const userLocation = localStorage.getItem('user_location') || 'Hyderabad, Telangana';
            
            try {
                // FIXED: Changed from /api/get-market-data to /api/personalized-market
                const response = await authFetch('/api/personalized-market', {
                    method: 'POST',
                    body: JSON.stringify({
                        crop: userCrop,
                        location: userLocation
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.market_data) {
                        updateMarketData(data.market_data);
                        return;
                    }
                }
            } catch (llmError) {
                console.log('LLM market data failed:', llmError);
            }
            
            const marketData = generateSimulatedMarketData(userCrop, userLocation);
            updateMarketData(marketData);
            
        } catch (error) {
            console.error('Market data load error:', error);
            updateMarketData({
                price: '₹ 2,100',
                crop: window.dashboardTranslations.current_rate,
                trend: 'up',
                trend_percentage: '1.2%'
            });
        }
    }
    
    function generateSimulatedMarketData(crop, location) {
        const cropPrices = {
            'Rice': { base: 2100, range: 300 },
            'Wheat': { base: 2300, range: 250 },
            'Maize': { base: 1900, range: 200 },
            'Cotton': { base: 6500, range: 500 },
            'Sugarcane': { base: 3200, range: 300 },
            'Tomato': { base: 1800, range: 400 },
            'Potato': { base: 1500, range: 300 },
            'Onion': { base: 2200, range: 500 },
            'Chickpea': { base: 5800, range: 400 },
            'Soybean': { base: 4500, range: 350 }
        };
        
        const cropKey = Object.keys(cropPrices).find(key => crop.includes(key)) || 'Rice';
        const basePrice = cropPrices[cropKey]?.base || 2100;
        const range = cropPrices[cropKey]?.range || 300;
        
        const randomPrice = basePrice + Math.floor(Math.random() * range) - (range/2);
        const formattedPrice = `₹ ${randomPrice.toLocaleString('en-IN')}`;
        
        const trends = ['up', 'down', 'stable'];
        const trend = trends[Math.floor(Math.random() * trends.length)];
        const trendPercentage = trend === 'up' ? (Math.random() * 2 + 0.5).toFixed(1) + '%' :
                              trend === 'down' ? (Math.random() * 1.5 + 0.3).toFixed(1) + '%' : window.dashboardTranslations.stable;
        
        return {
            price: formattedPrice,
            crop: crop,
            trend: trend,
            trend_percentage: trendPercentage
        };
    }
    
    function updateMarketData(marketData) {
        document.getElementById('marketPrice').textContent = marketData.price || '₹ 2,100';
        document.getElementById('marketCrop').textContent = marketData.crop || window.dashboardTranslations.current_rate;
        
        const trendContainer = document.getElementById('marketTrendContainer');
        const trendText = document.getElementById('marketTrend');
        
        if (marketData.trend) {
            if (marketData.trend === 'up') {
                trendContainer.className = 'inline-flex items-center mt-3 px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs';
                trendText.textContent = `↑ ${marketData.trend_percentage || '1.2%'}`;
            } else if (marketData.trend === 'down') {
                trendContainer.className = 'inline-flex items-center mt-3 px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs';
                trendText.textContent = `↓ ${marketData.trend_percentage || '0.8%'}`;
            } else {
                trendContainer.className = 'inline-flex items-center mt-3 px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs';
                trendText.textContent = window.dashboardTranslations.stable;
            }
            trendContainer.classList.remove('hidden');
        }
    }
    
    async function refreshMarketData() {
        const btn = document.querySelector('button[onclick="refreshMarketData()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> ${window.dashboardTranslations.refreshing}`;
        btn.disabled = true;
        
        try {
            await loadMarketData();
            btn.innerHTML = `<i class="fas fa-check mr-1"></i> ${window.dashboardTranslations.updated}`;
        } catch (error) {
            btn.innerHTML = `<i class="fas fa-times mr-1"></i> ${window.dashboardTranslations.failed}`;
        }
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    }
    
    // ========== FERTILIZER DATA ==========
    async function loadFertilizerData() {
        try {
            const userCrop = localStorage.getItem('primary_crop') || 'Rice';
            const farmSize = localStorage.getItem('farm_size') || '5 acres';
            
            try {
                const response = await authFetch('/api/fertilizer-recommendation', {
                    method: 'POST',
                    body: JSON.stringify({
                        crop: userCrop,
                        farm_size: farmSize
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.fertilizer_data) {
                        updateFertilizerData(data.fertilizer_data);
                        return;
                    }
                }
            } catch (llmError) {
                console.log('LLM fertilizer data failed:', llmError);
            }
            
            const fertilizerData = generateSimulatedFertilizerData(userCrop, farmSize);
            updateFertilizerData(fertilizerData);
            
        } catch (error) {
            console.error('Fertilizer data load error:', error);
            updateFertilizerData({
                npk_ratio: '10:26:26',
                quantity_per_acre: '120 kg',
                estimated_cost: '₹ 8,400',
                user_crop: window.dashboardTranslations.recommendation
            });
        }
    }
    
    function generateSimulatedFertilizerData(crop, farmSize) {
        const cropNPK = {
            'Rice': { npk: '20:10:10', quantity: 150, costPerAcre: 7000 },
            'Wheat': { npk: '18:46:0', quantity: 120, costPerAcre: 6500 },
            'Maize': { npk: '12:32:16', quantity: 180, costPerAcre: 8500 },
            'Cotton': { npk: '20:20:20', quantity: 200, costPerAcre: 9000 },
            'Sugarcane': { npk: '27:13:13', quantity: 250, costPerAcre: 11000 },
            'Tomato': { npk: '19:19:19', quantity: 100, costPerAcre: 5500 },
            'Potato': { npk: '12:32:16', quantity: 150, costPerAcre: 7000 },
            'Chickpea': { npk: '0:20:20', quantity: 80, costPerAcre: 4000 }
        };
        
        const cropKey = Object.keys(cropNPK).find(key => crop.includes(key)) || 'Rice';
        const npkData = cropNPK[cropKey] || cropNPK['Rice'];
        
        const sizeMatch = farmSize.match(/(\d+(\.\d+)?)/);
        const size = sizeMatch ? parseFloat(sizeMatch[1]) : 5;
        const totalCost = Math.round(npkData.costPerAcre * size);
        
        return {
            npk_ratio: npkData.npk,
            quantity_per_acre: `${npkData.quantity} kg`,
            estimated_cost: `₹ ${totalCost.toLocaleString('en-IN')}`,
            user_crop: crop
        };
    }
    
    function updateFertilizerData(fertilizerData) {
        document.getElementById('fertilizerNPK').textContent = `NPK: ${fertilizerData.npk_ratio || '10:26:26'}`;
        document.getElementById('fertilizerQuantity').textContent = `${fertilizerData.quantity_per_acre || '120 kg'}/acre`;
        document.getElementById('fertilizerCostText').textContent = fertilizerData.estimated_cost || '₹ 8,400';
        document.getElementById('fertilizerCrop').textContent = fertilizerData.user_crop || window.dashboardTranslations.recommendation;
    }
    
    // ========== FARM UPDATES - PLACEHOLDER UNTIL APP.PY IS UPDATED ==========
    async function loadFarmUpdates() {
        const updatesContainer = document.getElementById('farmUpdates');
        
        updatesContainer.innerHTML = `
            <div class="flex items-center justify-center py-6">
                <div class="spinner mr-3"></div>
                <p class="text-sm text-gray-500">{{ t('personalizing', user_language) }}</p>
            </div>
        `;
        
        try {
            const userCrop = localStorage.getItem('primary_crop') || 'Rice';
            const userLocation = localStorage.getItem('user_location') || 'Hyderabad, Telangana';
            const farmSize = localStorage.getItem('farm_size') || '5 acres';
            
            try {
                // This endpoint will be added to app.py next
                const response = await authFetch('/api/farm-updates', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.updates) {
                        renderFarmUpdates(data.updates);
                        return;
                    }
                }
            } catch (llmError) {
                console.log('LLM farm updates failed:', llmError);
            }
            
            const updates = generateSimulatedFarmUpdates(userCrop, userLocation);
            renderFarmUpdates(updates);
            
        } catch (error) {
            console.error('Farm updates load error:', error);
            renderFarmUpdates(getEmergencyUpdates());
        }
    }
    
    function renderFarmUpdates(updates) {
        const container = document.getElementById('farmUpdates');
        
        if (!updates || updates.length === 0) {
            container.innerHTML = getEmptyStateHTML();
            return;
        }
        
        container.innerHTML = updates.map(update => `
            <div class="flex items-start">
                <div class="w-8 h-8 bg-${update.bgColor} rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                    <i class="fas ${update.icon} text-${update.iconColor}"></i>
                </div>
                <div>
                    <div class="font-medium text-gray-800 text-sm">${update.title}</div>
                    <div class="text-xs text-gray-500">${update.content}</div>
                </div>
            </div>
        `).join('');
    }
    
    function generateSimulatedFarmUpdates(crop, location) {
        const currentMonth = new Date().getMonth();
        const seasons = ['winter', 'winter', 'spring', 'spring', 'spring', 'summer', 'summer', 'monsoon', 'monsoon', 'autumn', 'autumn', 'winter'];
        const currentSeason = seasons[currentMonth];
        
        return [
            {
                icon: 'fa-cloud-sun',
                iconColor: 'blue-500',
                bgColor: 'blue-100',
                title: '{{ t("weather_update", user_language) }}',
                content: `{{ t("favorable_conditions", user_language) }} ${location.split(',')[0]}.`
            },
            {
                icon: 'fa-seedling',
                iconColor: 'green-500',
                bgColor: 'green-100',
                title: '{{ t("crop_advice", user_language) }}',
                content: `{{ t("monitor_crop_health", user_language) }}`
            },
            {
                icon: 'fa-calendar-check',
                iconColor: 'yellow-500',
                bgColor: 'yellow-100',
                title: '{{ t("seasonal_task", user_language) }}',
                content: `{{ t("regular_monitoring", user_language) }}`
            }
        ];
    }
    
    function getEmergencyUpdates() {
        return [
            {
                icon: 'fa-cloud-sun',
                iconColor: 'blue-500',
                bgColor: 'blue-100',
                title: '{{ t("weather_update", user_language) }}',
                content: '{{ t("fair_weather", user_language) }}'
            },
            {
                icon: 'fa-seedling',
                iconColor: 'green-500',
                bgColor: 'green-100',
                title: '{{ t("crop_advice", user_language) }}',
                content: '{{ t("monitor_pest_activity", user_language) }}'
            },
            {
                icon: 'fa-chart-line',
                iconColor: 'yellow-500',
                bgColor: 'yellow-100',
                title: '{{ t("market_insight", user_language) }}',
                content: '{{ t("check_mandi_prices", user_language) }}'
            }
        ];
    }
    
    // ========== DASHBOARD DATA ==========
    async function loadDashboardData() {
        try {
            const response = await authFetch('/dashboard-data');
            if (!response.ok) {
                throw new Error('Failed to fetch dashboard data');
            }
            
            const data = await response.json();
            
            if (data.success) {
                if (data.user) {
                    updateUserInfo(data.user);
                }
                
                if (data.user?.primary_crop) {
                    document.getElementById('marketCrop').textContent = data.user.primary_crop;
                    document.getElementById('fertilizerCrop').textContent = data.user.primary_crop;
                }
            }
            
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
        }
    }
    
    function loadFallbackData() {
        const userName = localStorage.getItem('user-name') || 'User';
        const userCrop = localStorage.getItem('primary_crop') || 'Select crop';
        const userLocation = localStorage.getItem('user_location') || 'Set location';
        
        document.getElementById('userName').textContent = userName;
        document.getElementById('userInitial').textContent = userName.charAt(0).toUpperCase();
        document.getElementById('userLocation').textContent = userLocation;
        document.getElementById('weatherLocation').textContent = userLocation;
        document.getElementById('marketCrop').textContent = userCrop;
        document.getElementById('fertilizerCrop').textContent = userCrop;
        
        const hour = new Date().getHours();
        let greeting = window.dashboardTranslations.greeting_morning;
        if (hour >= 12 && hour < 18) greeting = window.dashboardTranslations.greeting_afternoon;
        if (hour >= 18) greeting = window.dashboardTranslations.greeting_evening;
        
        document.getElementById('welcomeMessage').textContent = `${greeting}, ${userName}`;
        
        let stats = [];
        if (userLocation !== 'Set location') stats.push(userLocation);
        if (userCrop !== 'Select crop') stats.push(userCrop);
        if (localStorage.getItem('farm_size')) stats.push(localStorage.getItem('farm_size'));
        document.getElementById('userStats').textContent = stats.join(' • ') || '{{ t("complete_profile_prompt", user_language) }}';
        
        loadMarketData();
        loadFertilizerData();
        loadFarmUpdates();
    }
    
    // ========== VIEW FERTILIZER DETAILS ==========
    function viewFertilizerDetails() {
        const fertilizerData = {
            npk_ratio: document.getElementById('fertilizerNPK').textContent.replace('NPK: ', ''),
            quantity_per_acre: document.getElementById('fertilizerQuantity').textContent,
            estimated_cost: document.getElementById('fertilizerCostText').textContent,
            crop: document.getElementById('fertilizerCrop').textContent
        };
        
        localStorage.setItem('fertilizer_details', JSON.stringify(fertilizerData));
        window.location.href = '/fertilizer.html';
    }
    
    // ========== PROFILE MANAGEMENT ==========
    async function checkProfileCompletion() {
        try {
            const response = await authFetch('/user/profile');
            const data = await response.json();
            
            if (data.success && data.user) {
                const user = data.user;
                
                if (!user.profile_completed || !user.state || !user.district || !user.primary_crop) {
                    setTimeout(() => showProfileModal(), 1000);
                }
            }
            
        } catch (error) {
            console.error('Profile check failed:', error);
        }
    }
    
    function showProfileModal() {
        const stateSelect = document.getElementById('stateSelect');
        const districtSelect = document.getElementById('districtSelect');
        const farmSizeInput = document.getElementById('farmSize');
        const cropSelect = document.getElementById('primaryCrop');
        const irrigationSelect = document.getElementById('irrigationType');
        const soilSelect = document.getElementById('soilType');
        
        const savedLocation = localStorage.getItem('user_location');
        const savedCrop = localStorage.getItem('primary_crop');
        const savedSize = localStorage.getItem('farm_size');
        const savedIrrigation = localStorage.getItem('irrigation_type');
        const savedSoil = localStorage.getItem('soil_type');
        
        if (savedLocation) {
            const [state, district] = savedLocation.split(',').map(s => s.trim());
            if (state) {
                stateSelect.value = state;
                loadDistricts(state);
                
                setTimeout(() => {
                    if (district && districtSelect.options.length > 0) {
                        districtSelect.value = district;
                    }
                }, 100);
            }
        }
        
        if (savedCrop) cropSelect.value = savedCrop;
        if (savedSize) {
            const match = savedSize.match(/(\d+(\.\d+)?)/);
            if (match) farmSizeInput.value = match[1];
        }
        if (savedIrrigation) irrigationSelect.value = savedIrrigation;
        if (savedSoil) soilSelect.value = savedSoil;
        
        document.getElementById('profileModal').classList.remove('hidden');
    }
    
    function hideProfileModal() {
        document.getElementById('profileModal').classList.add('hidden');
    }
    
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const state = document.getElementById('stateSelect').value;
        const district = document.getElementById('districtSelect').value;
        const farmSize = document.getElementById('farmSize').value;
        const primaryCrop = document.getElementById('primaryCrop').value;
        const irrigationType = document.getElementById('irrigationType').value;
        const soilType = document.getElementById('soilType').value;
        
        if (!state || !district || !farmSize || !primaryCrop) {
            alert(window.dashboardTranslations.required_fields);
            return;
        }
        
        const profileData = {
            state: state,
            district: district,
            farm_size: parseFloat(farmSize),
            primary_crop: primaryCrop
        };
        
        if (irrigationType) profileData.irrigation_type = irrigationType;
        if (soilType) profileData.soil_type = soilType;
        
        const saveBtn = document.getElementById('saveProfileBtn');
        const saveText = document.getElementById('saveProfileText');
        const spinner = document.getElementById('saveProfileSpinner');
        
        saveText.textContent = window.dashboardTranslations.saving;
        spinner.classList.remove('hidden');
        saveBtn.disabled = true;
        
        try {
            const response = await authFetch('/save-profile', {
                method: 'POST',
                body: JSON.stringify(profileData)
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                localStorage.setItem('user_location', `${state}, ${district}`);
                localStorage.setItem('farm_size', `${farmSize} acres`);
                localStorage.setItem('primary_crop', primaryCrop);
                localStorage.setItem('profile_completed', 'true');
                if (irrigationType) localStorage.setItem('irrigation_type', irrigationType);
                if (soilType) localStorage.setItem('soil_type', soilType);
                
                updateUserInfo(data.user || { 
                    username: localStorage.getItem('user-name'),
                    state: state,
                    district: district,
                    primary_crop: primaryCrop,
                    farm_size: farmSize
                });
                
                document.getElementById('marketCrop').textContent = primaryCrop;
                document.getElementById('fertilizerCrop').textContent = primaryCrop;
                
                hideProfileModal();
                
                await loadMarketData();
                await loadFertilizerData();
                await loadFarmUpdates();
                
                alert(window.dashboardTranslations.profile_saved);
                
            } else {
                throw new Error(data.message || 'Failed to save profile');
            }
            
        } catch (error) {
            console.error('Profile save error:', error);
            alert(window.dashboardTranslations.profile_save_error);
            
            localStorage.setItem('user_location', `${state}, ${district}`);
            localStorage.setItem('farm_size', `${farmSize} acres`);
            localStorage.setItem('primary_crop', primaryCrop);
            if (irrigationType) localStorage.setItem('irrigation_type', irrigationType);
            if (soilType) localStorage.setItem('soil_type', soilType);
            
            const userName = localStorage.getItem('user-name') || 'User';
            updateUserInfo({
                username: userName,
                state: state,
                district: district,
                primary_crop: primaryCrop,
                farm_size: farmSize
            });
            
            document.getElementById('marketCrop').textContent = primaryCrop;
            document.getElementById('fertilizerCrop').textContent = primaryCrop;
            
            hideProfileModal();
            
            await loadMarketData();
            await loadFertilizerData();
            await loadFarmUpdates();
            
            alert(window.dashboardTranslations.profile_saved_local);
        } finally {
            saveText.textContent = '{{ t("save_profile", user_language) }}';
            spinner.classList.add('hidden');
            saveBtn.disabled = false;
        }
    });
    
    // ========== WEATHER FUNCTIONS ==========
    async function loadRealWeather() {
        try {
            console.log('Loading weather data...');
            
            let coords = null;
            const userLocation = localStorage.getItem('user_location');
            
            if (userLocation) {
                const fallbackCoords = {
                    'hyderabad': { lat: 17.3850, lon: 78.4867 },
                    'delhi': { lat: 28.6139, lon: 77.2090 },
                    'mumbai': { lat: 19.0760, lon: 72.8777 },
                    'chennai': { lat: 13.0827, lon: 80.2707 },
                    'bengaluru': { lat: 12.9716, lon: 77.5946 },
                    'visakhapatnam': { lat: 17.6868, lon: 83.2185 },
                    'vijayawada': { lat: 16.5062, lon: 80.6480 },
                    'guntur': { lat: 16.3067, lon: 80.4365 },
                    'warangal': { lat: 17.9689, lon: 79.5941 },
                    'karimnagar': { lat: 18.4386, lon: 79.1288 },
                    'pune': { lat: 18.5204, lon: 73.8567 },
                    'nagpur': { lat: 21.1458, lon: 79.0882 }
                };
                
                const locationLower = userLocation.toLowerCase();
                for (const [city, cityCoords] of Object.entries(fallbackCoords)) {
                    if (locationLower.includes(city)) {
                        coords = cityCoords;
                        console.log(`Using coordinates for ${city}:`, coords);
                        break;
                    }
                }
            }
            
            if (!coords) {
                coords = { lat: 17.3850, lon: 78.4867 };
                console.log('Using default Hyderabad coordinates');
            }
            
            const response = await fetch(
                `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current=temperature_2m,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,apparent_temperature&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`
            );
            
            if (!response.ok) {
                console.error('Weather API failed with status:', response.status);
                throw new Error('Weather API failed');
            }
            
            const data = await response.json();
            console.log('Weather data received:', data.current);
            updateWeatherUI(data);
            checkWeatherAlerts(data);
            
        } catch (error) {
            console.error('Weather fetch failed:', error);
            showFallbackWeather();
        }
    }
    
    function updateWeatherUI(weatherData) {
        const current = weatherData.current;
        
        document.getElementById('weatherTemp').textContent = 
            `${Math.round(current.temperature_2m)}°C`;
        
        document.getElementById('weatherFeelsLike').textContent = 
            `${Math.round(current.apparent_temperature)}°C`;
        
        const condition = getWeatherCondition(current.weather_code);
        document.getElementById('weatherCondition').textContent = condition.text;
        
        document.getElementById('weatherIcon').className = `fas ${condition.icon} text-${condition.color} text-xl`;
        
        document.getElementById('weatherHumidity').textContent = 
            `${current.relative_humidity_2m}%`;
        document.getElementById('weatherWind').textContent = 
            `${Math.round(current.wind_speed_10m)} km/h`;
    }
    
    function getWeatherCondition(code) {
        if (code === 0) return { text: "Clear sky", icon: "fa-sun", color: "sun" };
        if (code === 1) return { text: "Mainly clear", icon: "fa-sun", color: "sun" };
        if (code === 2) return { text: "Partly cloudy", icon: "fa-cloud-sun", color: "sun" };
        if (code === 3) return { text: "Overcast", icon: "fa-cloud", color: "leaf" };
        if (code >= 45 && code <= 48) return { text: "Foggy", icon: "fa-smog", color: "leaf" };
        if (code >= 51 && code <= 67) return { text: "Rainy", icon: "fa-cloud-rain", color: "sky" };
        if (code >= 71 && code <= 77) return { text: "Snowy", icon: "fa-snowflake", color: "sky" };
        if (code >= 80 && code <= 82) return { text: "Rain showers", icon: "fa-cloud-showers-heavy", color: "sky" };
        if (code >= 95 && code <= 99) return { text: "Thunderstorm", icon: "fa-bolt", color: "sun" };
        return { text: "Unknown", icon: "fa-question", color: "leaf" };
    }
    
    function showFallbackWeather() {
        document.getElementById('weatherTemp').textContent = '28°C';
        document.getElementById('weatherFeelsLike').textContent = '30°C';
        document.getElementById('weatherCondition').textContent = 'Partly Cloudy';
        document.getElementById('weatherHumidity').textContent = '65%';
        document.getElementById('weatherWind').textContent = '12 km/h';
        document.getElementById('weatherIcon').className = 'fas fa-cloud-sun text-sun text-xl';
    }
    
    async function refreshWeather() {
        const refreshBtn = document.getElementById('refreshButton');
        const originalHTML = refreshBtn.innerHTML;
        
        refreshBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> ${window.dashboardTranslations.refreshing}`;
        refreshBtn.disabled = true;
        
        try {
            await loadRealWeather();
            refreshBtn.innerHTML = `<i class="fas fa-check mr-1"></i> ${window.dashboardTranslations.updated}`;
        } catch (error) {
            refreshBtn.innerHTML = `<i class="fas fa-times mr-1"></i> ${window.dashboardTranslations.failed}`;
        }
        
        setTimeout(() => {
            refreshBtn.innerHTML = originalHTML;
            refreshBtn.disabled = false;
        }, 2000);
    }
    
    function checkWeatherAlerts(weatherData) {
        const daily = weatherData.daily;
        
        let alertTitle = '';
        let alertMessage = '';
        
        if (daily.precipitation_sum[0] > 20) {
            alertTitle = window.dashboardTranslations.weather_alert_heavy_rain;
            alertMessage = `${daily.precipitation_sum[0]}mm ${window.dashboardTranslations.delay_field_work}`;
        }
        else if (daily.temperature_2m_min[0] < 5) {
            alertTitle = window.dashboardTranslations.weather_alert_frost;
            alertMessage = `${window.dashboardTranslations.protect_crops} (${daily.temperature_2m_min[0]}°C)`;
        }
        else if (daily.temperature_2m_max[0] > 40) {
            alertTitle = window.dashboardTranslations.weather_alert_heat_wave;
            alertMessage = `${window.dashboardTranslations.irrigate_crops} (${daily.temperature_2m_max[0]}°C)`;
        }
        
        if (alertTitle) {
            document.getElementById('alertTitle').textContent = alertTitle;
            document.getElementById('alertMessage').textContent = alertMessage;
            document.getElementById('weatherAlert').classList.remove('hidden');
        }
    }
    
    function hideWeatherAlert() {
        document.getElementById('weatherAlert').classList.add('hidden');
    }
    
    // ========== CHAT FUNCTIONS - FIXED ==========
    async function loadRecentChats() {
        try {
            const response = await authFetch('/user/chat-sessions');
            const data = await response.json();
            
            if (data.success && data.sessions && data.sessions.length > 0) {
                updateRecentChats(data.sessions.slice(0, 3));
            }
        } catch (error) {
            console.error('Failed to load chats:', error);
        }
    }
    
    function updateRecentChats(sessions) {
        const container = document.getElementById('recentChats');
        
        if (!sessions || sessions.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 text-gray-400">
                    <i class="fas fa-comment-dots text-xl mb-2"></i>
                    <p class="text-sm">{{ t('no_chats', user_language) }}</p>
                    <a href="chatbot.html" class="text-leaf text-xs hover:underline mt-1 inline-block">
                        {{ t('start_conversation', user_language) }}
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = sessions.map(session => `
            <div class="flex items-center justify-between p-2.5 bg-gray-50 rounded-lg hover:bg-gray-100">
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-800 text-sm truncate">
                        ${session.title || 'Chat'}
                    </div>
                    <div class="text-xs text-gray-500">
                        ${new Date(session.updated_at).toLocaleDateString()}
                    </div>
                </div>
                <a href="chatbot.html?session=${session.session_id}" 
                   class="text-leaf hover:text-green-700 ml-2">
                    <i class="fas fa-external-link-alt text-sm"></i>
                </a>
            </div>
        `).join('');
    }
    
    // FIXED: Chatbot redirect - uses sessionStorage with correct key
    function goToChatWithText(query) {
        const encodedQuery = encodeURIComponent(query);
        // FIXED: Use sessionStorage with key 'preset_chat_query' (matches chatbot.html)
        sessionStorage.setItem('preset_chat_query', query);
        // Also set in localStorage as backup
        localStorage.setItem('preset_query', query);
        window.location.href = `chatbot.html?q=${encodedQuery}`;
    }
    
    function goToChat(query) {
        goToChatWithText(query);
    }
    
    // ========== LOGOUT ==========
    async function logout() {
        try {
            await fetch(`${API_BASE}/logout`, {
                method: 'POST',
                credentials: 'include'
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
        
        localStorage.clear();
        window.location.href = 'login.html';
    }
    
    // ========== GLOBAL FUNCTIONS ==========
    window.showProfileModal = showProfileModal;
    window.hideProfileModal = hideProfileModal;
    window.hideWeatherAlert = hideWeatherAlert;
    window.refreshWeather = refreshWeather;
    window.refreshMarketData = refreshMarketData;
    window.loadFarmUpdates = loadFarmUpdates;
    window.goToChat = goToChat;
    window.goToChatWithText = goToChatWithText;
    window.viewFertilizerDetails = viewFertilizerDetails;
    window.logout = logout;
    
</script>
{% endblock %}